---
title: MySQL教程
categories: 七、数据库
tags: 数据库
layout: post
---



## 一、MySQL概述

### 逻辑架构

　　MySQL的逻辑架构如下图所示：

![MySQL逻辑架构图](./../assets/img/java/MySQL逻辑架构图.png)

　　第一层架构包括`连接/线程处理`，主要功能是连接处理、授权认证、安全等。

　　第二层架构包括`查询缓存`、`解析器`、`优化器`，大多数MySQL的核心功能都在这一层，包括查询解析、分析优化、缓存以及所有的内置函数，所有跨存储引擎的功能都在这一层实现：存储过程、触发器、视图等。

　　第三层架构包括`存储引擎`，存储引擎负责MySQL中数据的存储和提取。MySQL服务器通过API和存储引擎通信，这些接口屏蔽了不同存储引擎之间的差异，使得这些差异对上层的查询过程透明。不同的存储引擎之间不会互相通信，而只是简单地响应上层服务器的请求。

### 并发控制

* #### 读写锁

　　在处理并发读或并发写时，可以通过实现一个由两种数据类型的锁组成的锁系统来解决问题，这两种类型的锁通常被称为**共享锁(shared lock)**和**排他锁(exclusive lock)**，也叫**读锁(read lock)**和**写锁(write lock)**。

　　读写锁的特点是：**多个线程可以同时读取，但不可以读取时写入，也不可以写入时读取、写入时写入。**

* #### 锁粒度

　　在给定的资源上，锁定的数据量越少，系统的并发程度越高，因此要尽量只锁定需要修改的数据，而不是所有资源，从而在锁的开销和数据的安全性之间达到平衡。

　　MySQL提供了多种锁策略，其中**表锁(table lock)**和**行级锁(row lock)**是最重要的两个策略。表锁指的是使用读写锁锁定整张表，它是MySQL中最基本的锁策略，并且是开销最小的锁策略。而行级锁指的是使用读写锁锁定一行，行级锁的并发程度最高，但锁开销也最大。

> info "提示"
>
> 表锁在MySQL服务器层和存储引擎层都可以实现，而行级锁只在存储引擎层实现。

* #### 数据库事务

　　数据库事务指的是一组原子性的SQL，事务内的SQL要么全部执行成功，要么全部执行失败。一个运行良好的事务处理系统，必须有以下四个特性(**ACID特性**)：

　　**1、原子性(atomicity)**：事务中的操作要么全部成功提交，要么全部失败回滚。

　　**2、一致性(consistency)**：数据库总是从一个一致性的状态转换到另一个一致性的状态。

　　**3、隔离性(isolation)**：通常来说，一个事务在提交之前，它对数据库的修改对其它事务是不可见的。事务不同的隔离级别会影响它的隔离性。

　　**4、持久性(durability)**：一旦事务提交，它所做的修改就会永久保存到数据库中。

　　事务的ACID特性可以保证银行不会弄丢你的钱，一个兼容ACID的数据库系统，需要做很多复杂但可能用户并没有察觉到的工作，才能确保ACID的实现。

* #### 隔离级别

　　数据库事务的隔离级别指的是，不同事务之间的数据共享程度。**隔离级别越低，系统的并发程度越高，开销也越低，但是数据安全性也越低。**MySQL数据库的四种隔离级别，按照从低到高的顺序如下：

　　**1、READ UNCOMMITED(未提交读)**：一个事务中还没有提交的修改，在另一个事务中是可见的。这会导致**脏读**的出现，即读取到还没有提交的数据。一般这种隔离级别很少使用。

　　**2、READ COMMITED(提交读)**：一个事务中只有提交后的修改，在另一个事务中才是可见的。提交读不会出现脏读，但是会导致**不可重复读**，即在一个事务中进行两次读取，如果有另一个事务在这两次读取之间修改并提交了数据，会导致一个事务中的两次读取结果不一致。这种隔离级别是很多数据库的默认隔离级别，比如Oracle，但MySQL不是。

　　**3、REPEATABLE READ(可重复读)**：一个事务中即使是提交后的修改，更准确地说是更新(UPDATE)操作，在另一个事务中也是不可见的。这种隔离级别解决了不可重复读的问题，但是可能会出现**幻读**的问题。幻读指的是一个事务中提交后的插入、删除，在另一个事务中仍然是可见的。**MySQL的InnoDB引擎通过多版本并发控制(MVCC，Multiversion Concurrency Control)解决了幻读的问题。**可重复读是**MySQL数据库的默认隔离级别**。

　　**4、SERIALIZABLE(串行化)**：这是最高的隔离级别，它通过强制事务串行执行，避免了幻读的问题。这种隔离级别很少使用。

> info "提示"
>
> 可以认为MVCC是行级锁的一个变种，但是它在很多情况下避免了加锁操作，因此开销更低，虽然实现机制有所不同，但大都实现了非阻塞的读操作，写操作也只锁定必要的行。

### InnoDB存储引擎简介

　　InnoDB是MySQL的默认事务型存储引擎，也是最重要、使用最广泛的存储引擎。它被设计用来处理大量的短期事务，短期事务大部分情况下是正常提交的，很少会被回滚。InnoDB的性能和自动崩溃恢复特性，使得它在非事务型存储的需求中也很流行。除非有非常特别的原因需要使用其它的存储引擎，否则应该优先考虑InnoDB引擎。