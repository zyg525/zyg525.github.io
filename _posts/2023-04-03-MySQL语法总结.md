---
title: MySQL语法总结
tags: MySQL 数据库
layout: post
categories: 五、MySQL
---

　　本文基于MySQL5.7。

## 一、数据类型

　　MySQL数据类型可以分为三类：**数值型、字符串型、日期型**。

* ### 数值型

| 类型           | 范围(有符号)                                                 | 用途                 |
| -------------- | ------------------------------------------------------------ | -------------------- |
| SMALLINT       | [-2^15, 2^15-1]，2字节                                       | 整数                 |
| INT(或INTEGER) | [-2^31, 2^31-1]，4字节                                       | 整数                 |
| BIGINT         | [-2^63, 2^63-1]，8字节                                       | 整数                 |
| FLOAT(M,D)     | M代表总位数，D代表小数位数，例如FLOAT(5,2)的范围是[-999.99, 999.99]，4字节 | 单精度浮点数         |
| DOUBLE(M,D)    | M代表总位数，D代表小数位数，例如DOUBLE(5,2)的范围是[-999.99, 999.99]，8字节 | 双精度浮点数         |
| DECIMAL(M,D)   | M代表总位数，D代表小数位数，例如DECIMAL(5,2)的范围是[-999.99, 999.99] | 小数，**常用于金额** |

* ### 字符串型

| 类型    | 最大长度  | 用途       |
| ------- | --------- | ---------- |
| CHAR    | 255字符   | 定长字符串 |
| VARCHAR | 65535字节 | 变长字符串 |
| BLOB    | 65535字节 | 二进制数据 |
| TEXT    | 65535字节 | 长文本     |

　　注意，`CHAR(n)`和`VARCHAR(n)`中的n代表最大字符数，而非最大字节数。

* ### 日期型

| 类型      | 格式                | 用途      |
| --------- | ------------------- | --------- |
| DATE      | YYYY-MM-DD          | 日期      |
| TIME      | hh:mm:ss            | 时刻      |
| YEAR      | YYYY                | 年        |
| DATETIME  | YYYY-MM-DD hh:mm:ss | 日期+时刻 |
| TIMESTAMP | YYYY-MM-DD hh:mm:ss | 时间戳    |

　　在MySQL 5.6.4及之后版本，可以将TIMESTAMP精确到毫秒(`TIMESTAMP(3)`)和微秒(`TIMESTAMP(6)`)。

## 二、数据库操作

* ### 创建数据库

```sql
CREATE DATABASE db_test;
```

* ### 查询所有数据库

```sql
SHOW DATABASES;
```

* ### 查询当前数据库

```sql
SELECT DATABASE();
```

* ### 删除数据库

```sql
DROP DATABASE db_test;
```

* ### 切换数据库

```sql
USE db_test;
```

* ### 数据库元信息

　　1、查询数据库版本

```sql
SELECT VERSION();
```

　　2、查询当前用户

```sql
SELECT USER();
```

　　3、查询数据库配置

```sql
SHOW VARIABLES;
```

## 三、表结构操作

* ### 查询当前数据库中所有表

```sql
SHOW TABLES;
```

* ### 查询表中所有字段信息

```sql
DESC t_student;
```

* ### 查询表的建表语句

```sql
SHOW CREATE TABLE t_student;
```

* ### 创建表

```sql
CREATE TABLE IF NOT EXISTS t_student(
    id   INT   AUTO_INCREMENT          COMMENT '学生id',
    name VARCHAR(10)                   COMMENT '学生姓名',
    age  INT   NOT  NULL  DEFAULT 18   COMMENT '学生年龄',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY(id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

　　上表的`update_time`字段会随着数据更新而自动更新。

* ### 删除表

　　1、DROP：删除表结构

```sql
DROP TABLE t_student; 
```

　　2、TRUNCATE：清空表数据，但不改变表结构

```sql
TRUNCATE t_student;
```

* ### 复制表

　　1、复制一张表的表结构，但是不复制表数据

```sql
CREATE TABLE t_student_copy LIKE t_student;
```

　　2、复制一张表的表结构，同时复制所有行的数据。注意，无法做到只复制部分行的数据。

```sql
CREATE TABLE t_student_copy AS SELECT * FROM t_student;
```

　　3、只复制数据，表结构自己定义

```sql
CREATE TABLE IF NOT EXISTS t_student_copy(
    id   BIGINT     AUTO_INCREMENT     COMMENT '学生id_copy',
    name VARCHAR(50)                   COMMENT '学生姓名_copy',
    age  INT   NOT  NULL  DEFAULT 18   COMMENT '学生年龄_copy',
    PRIMARY KEY(id)
)select id,name,age from t_student
```

　　4、向一张已经存在的表中插入另一张表的数据

```sql
INSERT INTO t_student1 (name1,age1)
SELECT name2,age2 FROM t_student2 WHERE id>10;
```

* ### 修改表结构

　　1、增加一个字段

```sql
ALTER TABLE t_student ADD teacher VARCHAR(20) COMMENT '老师';
```

　　2、删除一个字段

```sql
ALTER TABLE t_student DROP teacher;
```

　　3、修改一个字段的属性

```sql
ALTER TABLE t_student MODIFY name VARCHAR(50) COMMENT '姓名';
```

　　4、修改一个字段的名称和属性

```sql
ALTER TABLE t_student CHANGE name new_name VARCHAR(100) COMMENT '姓名_新';
```

　　5、修改表名

```sql
ALTER TABLE t_student RENAME TO t_student_new;
```

## 四、修改数据

* ### 插入数据

```sql
INSERT INTO t_student
(id,name,age)
VALUES
(1,'张三',18),
(2,'李四',19),
(3,'王五',20);
```

* ### 更新数据

```sql
UPDATE t_student
SET
name='赵六', age=21
WHERE id=1;
```

* ### 删除数据

```sql
DELETE FROM t_student WHERE id=1;
```

## 五、查询数据

* ### 限制查询数量

```sql
SELECT * FROM t_student LIMIT 0,10; #从第1条数据开始，总共查询10条数据
```

* ### 排序

```sql
SELECT name FROM t_student ORDER BY age ASC, score DESC; #ASC代表升序，DESC代表降序
```

* ### 分组

```sql
#根据年级进行分组，并求出每个年级的平均分数，然后过滤出平均分数大于90的数据
SELECT grade,AVG(score) FROM t_student GROUP BY grade HAVING AVG(score)>90; 
```

　　`AVG()`是一个求平均数的聚合函数。很显然，我们无法查询除了分组字段和聚合函数外的其它字段。

* ### 查询条件的顺序

　　当存在多个查询条件时，它们的顺序是：

```sql
SELECT grade,AVG(score) FROM t_student
WHERE id>0
GROUP BY grade
HAVING AVG(score)>90
ORDER BY grade;
```

　　`WHERE`是在分组前过滤，`HAVING`是在分组后过滤，因此`HAVING`后可以使用聚合函数，而`WHERE`不行。

* ### 连接查询

　　1、内连接

```sql
SELECT t1.*,t2.*
FROM t_student1 t1
INNER JOIN t_student2 t2
ON t1.id = t2.id;
```

　　内连接会先查询出t1或t2的id，然后用这些id去t1或t2中匹配，如果匹配不到，则不返回任何结果。MySQL会自动选择t1和t2中较小的表，然后用小表驱动大表。

　　2、左连接

```sql
SELECT t1.*,t2.*
FROM t_student1 t1
LEFT JOIN t_student2 t2
ON t1.id = t2.id;
```

　　左连接会先查询出t1的id，然后用这些id去t2中匹配，如果匹配不到，则只返回t1中的结果，t2中的结果为NULL；如果匹配到多条，则返回所有匹配的结果。在左连接中MySQL使用左表驱动右表，所以左表数据尽量少一点。

　　3、右连接

```sql
SELECT t1.*,t2.*
FROM t_student1 t1
RIGHT JOIN t_student2 t2
ON t1.id = t2.id;
```

　　右连接相当于把左连接反过来，原理是一样的。

* ### 合并查询结果

　　1、UNION：合并查询结果并去重

```sql
SELECT id,name,age FROM t_stduent1
UNION
SELECT id,name,age FROM t_student2;
```

　　2、UNION ALL：合并查询结果但不去重

```sql
SELECT id,name,age FROM t_stduent1
UNION ALL
SELECT id,name,age FROM t_student2;
```

* ### EXISTS

　　`EXISTS`返回一个布尔值，常见用法如下：

```sql
SELECT t1.* FROM t_student1 t1
WHERE EXISTS
(SELECT 1 FROM t_student2 t2 WHERE t1.id=t2.id);
```

　　`NOT EXISTS`的原理相同。

* ### NULL值的比较

　　可以通过`IS NULL`和`IS NOT NULL`来判断一个值是否为NULL，如果要比较两个值是否相等，可以使用`=`，当相等时返回1，不相等时返回0，它的缺点是当两个值中有一个为NULL时会返回NULL，此时可以用`<=>`(安全等于)，当两个值一个为NULL另一个不为NULL时返回0，当两个值都为NULL时返回1。

* ### 正则表达式匹配

```sql
SELECT * FROM t_student WHERE age REGEXP '[0-9]{2}'; #匹配2位的整数
```

## 六、函数

* ### 处理函数

　　1、除法，不会取整

```sql
SELECT score/3 FROM t_student;
```

　　2、取余数

```sql
SELECT score%3 FROM t_student;
```

　　3、转换精度，遵循四舍五入(5也舍)

```sql
SELECT ROUND(score,2) FROM t_student; #将score精确到小数点两位
```

　　4、向上取整和向下取整

```sql
SELECT CEILING(score) FROM t_student; #向上取整
SELECT FLOOR(score) FROM t_student; #向下取整
```

　　5、大小写转换

```sql
SELECT LOWER(name) FROM t_student; #字母转换为小写
SELECT UPPER(name) FROM t_student; #字母转换为大写
```

　　6、截取字符串

```sql
SELECT SUBSTR(name,1,2) FROM t_student; #从第1个字符开始(包括第1个字符)，截取长度为2的子串
```

　　7、获取字段长度

```sql
SELECT LENGTH(name) FROM t_student;
```

　　8、转换NULL值

```sql
SELECT IFNULL(score,0) FROM t_student; #如果score是NULL，则返回0
```

　　9、返回第一个不为NULL的值

```sql
SELECT COALESCE(NULL,score,NULL) FROM t_student; #返回第一个不为NULL的值
```

　　`COALESCE()`可以用来替换`IFNULL()`函数。

　　10、CASE...WHEN

　　第一种用法：

```sql
SELECT
(CASE sex
WHEN 'male' THEN '男性'
WHEN 'female' THEN '女性'
ELSE '未知' END) AS sex_zh
FROM t_student;
```

　　第二种用法：

```sql
SELECT
(CASE
WHEN score>=90 THEN '优'
WHEN score>=80 THEN '良'
ELSE '一般' END) AS rank
FROM t_student;
```

　　11、去除首尾空格

```sql
SELECT TRIM(name) FROM t_student;
```

　　12、生成随机数

```sql
SELECT RAND() FROM t_student; #生成[0,1]之间的随机数
```

　　13、字符串转日期

```sql
SELECT * FROM t_log WHERE log_time > str_to_date('04-05-2023 10:44:33','%m-%d-%Y %H:%i:%s');
```

　　其中，日期的格式如下：

　　`%Y`代表4位的年份，`%y`代表2位的年份，`%m`代表格式为01、02的月份，`%c`代表格式为1、2的月份，`%d`代表日，`%H`代表24制的小时，`%h`代表12制的小时，`%i`代表格式为01、02的分钟，`%s`代表秒。

　　14、日期转字符串

```sql
SELECT DATE_FORMAT(log_time,'%Y-%m-%d') AS log_time_str FROM t_log;
```

　　日期格式和上面一样。

　　15、时间戳和日期互相转换

```sql
SELECT FROM_UNIXTIME(1661997078,'%Y-%m-%d') FROM t_student; #时间戳转日期
SELECT UNIX_TIMESTAMP(log_time) FROM t_student; #日期转时间戳
```

　　16、拼接字段

　　将多个字段转换为字符串然后拼接起来：

```sql
SELECT CONCAT(id,name,age) FROM t_student; #将id、name、age拼接起来
SELECT CONCAT_WS('-',id,name,age) FROM t_student; #将id、name、age用'-'拼接起来
```

　　分组拼接：将多个字段拼接起来，并将同一组内的所有记录用`','`拼接起来，这是一个聚合函数:

```sql
SELECT GROUP_CONCAT(id,name,age) FROM t_student GROUP BY age;
```

　　17、替换

```sql
SELECT REPLACE(name,'a','A') FROM t_student; #将name字段中的'a'替换为'A'
```

* ### 聚合函数

　　1、求数量

```sql
SELECT grade,COUNT(id) FROM t_student GROUP BY grade;
```

　　2、求和

```sql
SELECT grade,SUM(score) FROM t_student GROUP BY grade;
```

　　3、求平均数

```sql
SELECT grade,AVG(score) FROM t_student GROUP BY grade;
```

　　4、求最大值、最小值

```sql
SELECT grade,MAX(score),MIN(score) FROM t_student GROUP BY grade;
```

　　5、去重

```sql
SELECT DISTINCT id,name,age FROM t_student; #对id、name、age都相同的结果去重
```

* ### 窗口函数

　　sql server、oracle支持窗口函数，MySQL从8.0开始支持窗口函数。

　　1、RANK()函数

　　查询所有数据，根据age进行分组，组内根据score进行排序，生成序号ranking，如果序号相同，会跳过后面的序号，比如`1,1,1,4...`。

```sql
SELECT t.*, RANK() OVER (PARTITION BY age ORDER BY score) AS ranking
FROM t_student t;
```

　　2、DENSE_RANK()函数

　　和RANK()的作用类似，但是当序号相同，不会跳过后面的序号，比如`1,1,1,2...`。

```sql
SELECT t.*, DENSE_RANK() OVER (PARTITION BY age ORDER BY score) AS ranking
FROM t_student t;
```

　　3、ROW_NUMBER()函数

　　和RANK()的作用类似，但是即使数据相同，也不会出现相同的序号，比如`1,2,3,4...`。

```sql
SELECT t.*, ROW_NUMBER() OVER (PARTITION BY age ORDER BY score) AS number
FROM t_student t;
```

## 七、索引

* ### 创建索引

　　1、查询表中的所有索引

```sql
SHOW INDEX FROM t_student;
```

　　2、创建普通索引

```sql
CREATE INDEX index_name_age ON t_student(name,age) COMMENT 'name与age的联合索引';
```

　　3、创建唯一索引

　　唯一索引不允许出现相同的值，但允许出现多个NULL值。

```sql
CREATE UNIQUE INDEX index_name_age ON t_student(name,age) COMMENT 'name与age的唯一联合索引';
```

* ### 删除索引

```sql
DROP INDEX index_name_age ON t_student;
```

* ### 唯一约束

　　当为某些字段创建唯一约束时，会自动为这些字段创建唯一索引，因为唯一约束需要通过检查索引来保证唯一性。唯一约束也允许出现多个NULL值。

　　1、创建唯一约束

```sql
ALTER TABLE t_student ADD CONSTRAINT name_age_uk UNIQUE (name,age); #会自动为name、age创建唯一联合索引
```

　　2、删除唯一约束

```sql
ALTER TABLE t_student DROP INDEX name_age_uk;
```

## 八、事务

　　1、手动开启事务

```SQL
BEGIN; #手动开启一个事务
ROLLBACK; #回滚事务
COMMIT; #手动提交事务
```

　　2、开启自动事务

```sql
SET AUTOCOMMIT=0; #关闭自动提交
SET AUTOCOMMIT=1; #开启自动提交
```
