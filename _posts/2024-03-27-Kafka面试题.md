---
title: Kafka面试题
tags: 消息中间件
layout: post
categories: 十五、消息中间件
---



## 一、使用消息中间件有什么优点和缺点？

　　主要有三点好处：

　　**1、异步执行任务：**假如系统A要向系统B发送消息，如果没有消息中间件，系统A必须等待系统B处理完消息后才能继续运行，而有了消息中间件，系统A可以直接把消息放到消息中间件中，然后去执行自己的任务，系统B怎么消费消息自己决定。

　　**2、解耦：**假如系统A要向系统B发送消息，系统B如果出现故障，会影响系统A的运行，有了消息中间件后，系统B只和消息中间件打交道，不会影响系统A的运行。

　　**3、削峰填谷：**假如系统A要向系统B发送消息，而系统A发送消息的数量远大于系统B所能处理的数量，这就会给系统A和B造成很大压力，而有了消息中间件后，系统A可以把消息保存到消息中间件中，而不用考虑系统B的处理能力，系统B也可以按照自己的能力处理这些消息。

　　缺点主要是：

　　**1、系统复杂度升高、可用性降低。**

## 二、Kafka是如何实现高可用的？

　　**1、一个主题多个节点：**Kafka的一个主题中有多个分区，这些分区可以分布在多个节点上，这样当某个节点出现故障时，还有其它分区可以使用。

　　**2、分区副本：**Kafka的每个分区都有自己的**副本**，这些副本也可以分布在多个节点上。我们把最开始的分区叫做主分区，把这些副本叫做副本分区，生产者和消费者只和主分区打交道。**生产消息时**，生产者向主分区发送消息，副本分区会同步主分区的消息，当主分区和副本分区都收到消息后，主分区才会返回成功的消息给生产者。**消费消息时**，只有被主分区、副本分区都同步过的消息才会被消费。如果某个副本**分区不可用**了，还有主分区和其它副本分区可以使用，而如果主分区不可用了，就会从副本分区中选举出一个主分区。

## 三、怎样保证Kafka消息不被重复消费（如何保证消息消费时的幂等性）？

　　**Kafka会在以下情况下出现消息重复消费：**

　　Kafka中每个分区内的消息都有一个偏移量`offset`，它代表了这条消息在分区中的位置，消费者每隔几秒就会把当前消费到的偏移量提交给Kafka，这样当消费者重启或被更换后，就可以从上一次消费到的位置开始消费。但是如果消费者还没来得及提交偏移量就出现问题，此时提交的偏移量不是最新的，当消费者重启或被更换后，就会造成重复消费。可以通过减少提交间隔来减少重复消费的数量，但不能完全避免重复消费，所以关键是发生重复消费后如何保证幂等性。

　

　　**保证消息消费时的幂等性的方法主要有：**

　　**1、利用数据库的唯一约束：**比如向MySQL插入数据时，消息中携带主键，插入的时候使用`INSERT INTO IF NOT EXIST`，就可以避免因重复插入导致的主键冲突，在MySQL中的写法是`INSERT INTO ... ON DUPLICATE KEY UPDATE ...`(如果主键冲突则更新)。再比如Redis中的key是不能重复的，因此不管`SET`多少次相同的消息都不影响结果。

　　**2、自定义唯一ID：**我们还可以给消息添加一个唯一ID，每次消费后都把消息的唯一ID保存到数据库中，每次消费前都去数据库中查询ID是否已经存在了，如果不存在才进行消费。

## 四、怎样保证Kafka消息的可靠性（如何处理消息丢失的问题）？

